trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  AWS_REGION: 'us-east-1'
  ECR_URI: '474668397798.dkr.ecr.us-east-1.amazonaws.com/spring-boot-app'
  CLUSTER_NAME: 'eks-dev-cluster'
  TF_IN_AUTOMATION: 'true'

stages:
  - stage: TerraformEKS
    displayName: 'Provision EKS via Terraform'
    jobs:
      - job: Terraform
        displayName: 'Run Terraform'
        steps:
          - checkout: self

          - task: AWSCLI@1
            name: awsLogin
            displayName: 'Inject AWS Credentials'
            inputs:
              awsCredentials: 'aws-devops-admin'
              awsRegion: '$(AWS_REGION)'
              awsCommand: 'sts'
              awsSubCommand: 'get-caller-identity'
              outputVariables: 'awsAccessKeyId,awsSecretAccessKey,awsSessionToken'

          - task: TerraformInstaller@1
            inputs:
              terraformVersion: '1.6.6'

          - script: terraform init
            displayName: 'Terraform Init'
            env:
              AWS_ACCESS_KEY_ID: $[ dependencies.TerraformJob.outputs['awsLogin.awsAccessKeyId'] ]
              AWS_SECRET_ACCESS_KEY: $[ dependencies.TerraformJob.outputs['awsLogin.awsSecretAccessKey'] ]
              AWS_SESSION_TOKEN: $[ dependencies.TerraformJob.outputs['awsLogin.awsSessionToken'] ]

          - script: terraform plan -out=tfplan
            displayName: 'Terraform Plan'
            env:
              AWS_ACCESS_KEY_ID: $[ dependencies.TerraformJob.outputs['awsLogin.awsAccessKeyId'] ]
              AWS_SECRET_ACCESS_KEY: $[ dependencies.TerraformJob.outputs['awsLogin.awsSecretAccessKey'] ]
              AWS_SESSION_TOKEN: $[ dependencies.TerraformJob.outputs['awsLogin.awsSessionToken'] ]

          - script: terraform apply -auto-approve tfplan
            displayName: 'Terraform Apply'
            env:
              AWS_ACCESS_KEY_ID: $[ dependencies.TerraformJob.outputs['awsLogin.awsAccessKeyId'] ]
              AWS_SECRET_ACCESS_KEY: $[ dependencies.TerraformJob.outputs['awsLogin.awsSecretAccessKey'] ]
              AWS_SESSION_TOKEN: $[ dependencies.TerraformJob.outputs['awsLogin.awsSessionToken'] ]

  - stage: BuildAndPush
    displayName: 'Build and Push Docker Image'
    dependsOn: TerraformEKS
    jobs:
      - job: Build
        displayName: 'Docker Build & Push'
        steps:
          - checkout: self

          - task: AWSCLI@1
            name: awsLogin
            displayName: 'Inject AWS Credentials'
            inputs:
              awsCredentials: 'aws-devops-admin'
              awsRegion: '$(AWS_REGION)'
              awsCommand: 'sts'
              awsSubCommand: 'get-caller-identity'
              outputVariables: 'awsAccessKeyId,awsSecretAccessKey,awsSessionToken'

          - task: Maven@3
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'clean package'
              options: '-DskipTests'
            displayName: 'Build Spring Boot App'

          - script: docker build -t $(ECR_URI):latest .
            displayName: 'Build Docker Image'

          - script: |
              aws ecr get-login-password --region $(AWS_REGION) \
              | docker login --username AWS --password-stdin $(ECR_URI)
            displayName: 'Docker Login to ECR'
            env:
              AWS_ACCESS_KEY_ID: $[ dependencies.BuildJob.outputs['awsLogin.awsAccessKeyId'] ]
              AWS_SECRET_ACCESS_KEY: $[ dependencies.BuildJob.outputs['awsLogin.awsSecretAccessKey'] ]
              AWS_SESSION_TOKEN: $[ dependencies.BuildJob.outputs['awsLogin.awsSessionToken'] ]

          - script: docker push $(ECR_URI):latest
            displayName: 'Push Image to ECR'

  - stage: DeployToEKS
    displayName: 'Deploy to EKS'
    dependsOn: BuildAndPush
    jobs:
      - job: Deploy
        displayName: 'Kubernetes Deploy'
        steps:
          - checkout: self

          - task: AWSCLI@1
            name: awsLogin
            displayName: 'Inject AWS Credentials'
            inputs:
              awsCredentials: 'aws-devops-admin'
              awsRegion: '$(AWS_REGION)'
              awsCommand: 'sts'
              awsSubCommand: 'get-caller-identity'
              outputVariables: 'awsAccessKeyId,awsSecretAccessKey,awsSessionToken'

          - script: |
              aws eks update-kubeconfig --name $(CLUSTER_NAME) --region $(AWS_REGION)
            displayName: 'Configure kubectl'
            env:
              AWS_ACCESS_KEY_ID: $[ dependencies.DeployJob.outputs['awsLogin.awsAccessKeyId'] ]
              AWS_SECRET_ACCESS_KEY: $[ dependencies.DeployJob.outputs['awsLogin.awsSecretAccessKey'] ]
              AWS_SESSION_TOKEN: $[ dependencies.DeployJob.outputs['awsLogin.awsSessionToken'] ]

          - script: |
              kubectl apply -f deployment/deployment.yaml
              kubectl apply -f deployment/service.yaml
            displayName: 'Deploy to EKS'
